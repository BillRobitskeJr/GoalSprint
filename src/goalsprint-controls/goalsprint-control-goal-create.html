<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../bower_components/paper-radio-group/paper-radio-group.html">
<link rel="import" href="../../bower_components/paper-radio-button/paper-radio-button.html">

<dom-module id="goalsprint-control-goal-create">
  <template>
    <style>
      :host {
        display: block;
      }
      :host div paper-input {
        display: inline-block;
      }
    </style>

    <paper-dialog id="newGoalDialog"
      on-iron-overlay-closed="_handleDialogClosed">
      <h2>Set a new goal</h2>
      <paper-input label="Title (optional)" value="{{goal.title}}"></paper-input>
      <h3>My goal</h3>
      <div>
        Complete
        <paper-input label="Total activity" value="{{_activityTotal}}" type="number" required></paper-input>
        <paper-input label="Activity units" value="{{goal.activityUnit}}" type="text" required></paper-input>
        in
        <paper-input label="Duration" value="{{_duration}}" type="number" required></paper-input>
        days, starting
        <paper-input label="Start date" value="{{_startDate}}" required></paper-input>.
      </div>
      <h3>How</h3>
      <div>
        To reach this goal, complete
        [[_calculateDailyActivity(goal.activityTotal, goal.duration)]]
        [[goal.activityUnit]] each day from [[_formatDate(goal.startDate)]] to
        [[_formatDate(_endDate)]].
      </div>
      <paper-textarea label="Description (optional)" value="{{goal.description}}"></paper-textarea>
      <div>
        <paper-button dialog-confirm>Create</paper-button>
        <paper-button dialog-dismiss>Cancel</paper-button>
      </div>
    </paper-dialog>
  </template>
  <script>
    Polymer({
      is: 'goalsprint-control-goal-create',

      properties: {
        goal: {
          type: Object,
          value: function() {
            var startDate = new Date();
            return {
              title: '',
              activityTotal: 90,
              activityUnit: 'items',
              duration: 30,
              description: '',
              startDate: startDate
            };
          },
          notify: true
        },
        user: {
          type: Object
        },
        _startDate: {
          type: String,
          value: ''
        },
        _activityTotal: {
          type: String,
          value: '90'
        },
        _duration: {
          type: String,
          value: '30'
        },
        _endDate: {
          type: Date,
          computed: '_calculateEndDate(goal.startDate, goal.duration)'
        }
      },

      observers: [
        '_goalStartDateChanged(goal.startDate)',
        '_startDateStringChanged(_startDate)',
        '_goalActivityTotalChanged(goal.activityTotal)',
        '_activityTotalStringChanged(_activityTotal)',
        '_goalDurationChanged(goal.duration)',
        '_durationStringChanged(_duration)'
      ],

      open: function() {
        this.$.newGoalDialog.open();
      },

      _calculateDailyActivity: function(activityTotal, duration) {
        if (activityTotal && duration && duration > 0) {
          return Math.round(activityTotal / duration);
        } else {
          return null;
        }
      },

      _calculateEndDate: function(startDate, duration) {
        if (startDate && duration && duration > 0) {
          var endDate = new Date(startDate);
          endDate.setDate(endDate.getDate() + duration - 1);
          return endDate;
        } else {
          return null;
        }
      },

      _formatDate: function(date) {
        return date ? date.toLocaleDateString() : '';
      },

      _goalStartDateChanged: function(startDate) {
        if (!isNaN(startDate)) {
          var startDateString = this._formatDate(startDate);
          if (startDateString !== this._startDate) this._startDate = startDateString;
        }
      },

      _startDateStringChanged: function(startDateString) {
        var startDate = new Date(startDateString);
        if (!isNaN(startDate) && startDate !== this.goal.startDate) {
          this.goal.startDate = startDate;
          this.notifyPath('goal.startDate', this.goal.startDate);
        }
      },

      _goalActivityTotalChanged: function(activityTotal) {
        if (!isNaN(activityTotal)) {
          var activityTotalString = activityTotal.toString();
          if (activityTotalString !== this._activityTotal) this._activityTotal = activityTotalString;
        }
      },

      _activityTotalStringChanged: function(activityTotalString) {
        var activityTotal = parseInt(activityTotalString);
        if (!isNaN(activityTotal) && activityTotal !== this.goal.activityTotal) {
          this.goal.activityTotal = activityTotal;
          this.notifyPath('goal.activityTotal', this.goal.activityTotal);
        }
      },

      _goalDurationChanged: function(duration) {
        if (!isNaN(duration)) {
          var durationString = duration.toString();
          if (durationString !== this._duration) this._duration = durationString;
        }
      },

      _durationStringChanged: function(durationString) {
        var duration = parseInt(durationString);
        if (!isNaN(duration) && duration !== this.goal.duration) {
          this.goal.duration = duration;
          this.notifyPath('goal.duration', this.goal.duration);
        }
      },

      _handleDialogClosed: function(event) {
        if (window.console && window.console.log) window.console.log(event.detail);
        if (!event.detail.canceled && event.detail.confirmed) {
          this.fire('create-confirmed', { newGoal: this.goal });
        } else {
          this.fire('create-canceled');
        }
      }
    });
  </script>
</dom-module>
